name: Practo Test Pipeline
description: Orchestrates Java Selenium, Playwright Axe, and JMeter tests

on:
  workflow_dispatch:

jobs:
  run-all-tests:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Orchestrator Repo
      uses: actions/checkout@v4

    - name: Checkout Java/Maven/Selenium Project
      uses: actions/checkout@v4
      with:
        repository: aymanebouchaara/PractoTestFramework
        path: java-selenium

    - name: Set up Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Run Java Selenium Tests
      working-directory: java-selenium
      run: mvn clean -Dtest=CucumberTestRunner test
      continue-on-error: true

    - name: Upload ExtentReports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: extent-reports
        path: java-selenium/test-output/ExtentReport.html

    - name: Checkout Playwright/Axe Project
      uses: actions/checkout@v4
      with:
        repository: aymanebouchaara/PractoAccessibilityTesting
        path: playwright-axe

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install and Run Playwright Tests
      working-directory: playwright-axe
      run: |
        npm ci
        npx playwright install
        npm test

    - name: Upload Playwright Report
      uses: actions/upload-artifact@v4
      with:
        name: playwright-report
        path: playwright-axe/a11y-reports/*.html

    - name: Checkout JMeter Project
      uses: actions/checkout@v4
      with:
        repository: aymanebouchaara/PractoPerformanceTesting
        path: jmeter-tests

    - name: Install JMeter manually
      working-directory: jmeter-tests
      run: |
        sudo apt-get remove -y jmeter
        sudo apt-get update
        sudo apt-get install -y openjdk-17-jdk wget
        wget https://archive.apache.org/dist/jmeter/binaries/apache-jmeter-5.6.3.tgz
        tar xzf apache-jmeter-5.6.3.tgz

    - name: Run JMeter Tests
      working-directory: jmeter-tests/apache-jmeter-5.6.3
      run: |
        ./bin/jmeter -n \
          -t ../tests/PractoPerfomanceTesting.jmx \
          -l ../../execresults/results.jtl
      continue-on-error: true

    - name: Debug JMeter Results File
      working-directory: jmeter-tests/execresults
      run: |
        if [ -f results.jtl ]; then
          echo "results.jtl exists:"
          cat results.jtl
        else
          echo "results.jtl not found!"
        fi

    - name: Generate HTML Dashboard
      working-directory: jmeter-tests/apache-jmeter-5.6.3
      run: |
        ./bin/jmeter -g ../../execresults/results.jtl \
          -o ../../execresults || echo "HTML generation failed"

    - name: Debug HTML Report Directory
      working-directory: jmeter-tests/execresults
      run: |
        if [ -d html-report ]; then
          echo "HTML report directory exists:"
          ls -R html-report
        else
          echo "HTML report directory not found!"
        fi

    - name: Upload JMeter Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: jmeter-results
        path: jmeter-tests/execresults


